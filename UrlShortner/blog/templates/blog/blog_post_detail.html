{% extends 'layout.html' %}
{% load static %}

{% block content %}
<!-- Reading Progress Bar -->
<div class="fixed top-0 left-0 h-1 bg-gradient-to-r from-stone-500 to-stone-600 z-50 transition-all duration-100"
    id="readingProgress" style="width: 0%"></div>

<article class="min-h-screen bg-stone-50 font-serif text-lg leading-relaxed text-stone-700">

    <!-- Immersive Header -->
    <header class="relative w-full h-[60vh] min-h-[400px] flex flex-col justify-end overflow-hidden group">
        {% if post.cover_image %}
        <div class="absolute inset-0">
            <img src="{{ post.cover_image.url }}" alt="{{ post.title }}"
                class="w-full h-full object-cover transform group-hover:scale-105 transition-transform duration-[2s]">
            <div class="absolute inset-0 bg-gradient-to-t from-stone-900 via-stone-900/40 to-transparent opacity-90">
            </div>
        </div>
        {% else %}
        <div class="absolute inset-0 bg-gradient-to-br from-stone-700 to-stone-800"></div>
        {% endif %}

        <div class="relative max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 pb-16 w-full text-white">
            <!-- Breadcrumb -->
            <div class="flex items-center gap-2 text-sm text-white/70 mb-6 font-sans">
                <a href="{% url 'blog:blog_home' %}" class="hover:text-white transition-colors">Blog</a>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
                <span class="truncate max-w-[200px]">{{ post.title }}</span>
            </div>

            <h1 class="text-4xl md:text-5xl lg:text-6xl font-bold tracking-tight mb-6 leading-tight font-sans">
                {{ post.title }}
            </h1>

            <div class="flex items-center gap-6 font-sans">
                <!-- Author -->
                <div class="flex items-center gap-3">
                    {% if post.author.profile_picture %}
                    <img src="{{ post.author.profile_picture.url }}"
                        class="w-12 h-12 rounded-full border-2 border-white/20">
                    {% else %}
                    <div
                        class="w-12 h-12 rounded-full bg-white/10 border border-white/20 flex items-center justify-center">
                        <span class="text-xl text-white">{{ post.author.user.username|slice:":1"|upper }}</span>
                    </div>
                    {% endif %}
                    <div>
                        <p class="font-bold text-base">{{ post.author.user.get_full_name |default:post.author.user.username }}</p>
                        <div class="flex items-center gap-2 text-sm text-white/70">
                            <span>{{ post.published_at|date:"M d, Y" }}</span>
                            <span>•</span>
                            <span>{{ post.read_time }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Content Layout -->
    <div class="max-w-7xl mx-auto flex flex-col lg:flex-row gap-12 px-4 sm:px-6 lg:px-8 py-16">

        <!-- Social Sidebar (Desktop) -->
        <aside class="hidden lg:block w-16 pt-2">
            <div class="sticky top-24 flex flex-col gap-6 items-center">
                <button onclick="toggleLike('{{ post.id }}')" id="likeBtn-desk"
                    class="group flex flex-col items-center gap-1">
                    <div id="likeIcon-desk"
                        class="p-3 rounded-full transition-all shadow-sm border border-stone-200 {% if user_has_liked %}bg-red-50 text-red-500{% else %}bg-stone-100 text-stone-400 group-hover:bg-red-50 group-hover:text-red-500{% endif %}">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                            <path
                                d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
                        </svg>
                    </div>
                    <span class="text-xs font-sans font-medium text-stone-500" id="likeCount-desk">{{ post.likes.count }}</span>
                </button>

                <div class="w-8 h-px bg-stone-200"></div>

                <button onclick="copyLink()"
                    class="p-3 rounded-full bg-stone-100 text-stone-500 hover:bg-stone-200 hover:text-stone-700 transition-all shadow-sm border border-stone-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1">
                        </path>
                    </svg>
                </button>
            </div>
        </aside>

        <!-- Main Article -->
        <main class="flex-1 max-w-3xl">
            <!-- Article Body -->
            <div
                class="prose prose-lg prose-stone max-w-none 
                        prose-headings:font-sans prose-headings:font-bold prose-h1:text-4xl prose-h2:text-3xl
                        prose-a:text-stone-700 prose-a:no-underline hover:prose-a:underline
                        prose-img:rounded-3xl prose-img:shadow-xl
                        first-letter:text-7xl first-letter:font-bold first-letter:text-stone-800 first-letter:mr-3 first-letter:float-left">
                {{ post.content|safe }}
            </div>

            <!-- Mobile Interactions (Bottom) -->
            <div
                class="lg:hidden fixed bottom-0 left-0 right-0 bg-stone-50/90 backdrop-blur border-t border-stone-200 p-4 flex justify-between items-center z-40">
                <button onclick="toggleLike('{{ post.id }}')" id="likeBtn-mobile"
                    class="flex items-center gap-2 px-4 py-2 rounded-full font-bold {% if user_has_liked %}bg-red-100 text-red-600{% else %}bg-red-50 text-red-600{% endif %}">
                    <span id="likeIcon-mobile">{% if user_has_liked %}❤{% else %}♥{% endif %}</span>
                    <span id="likeCount-mobile">{{ post.likes.count }}</span>
                </button>
                <div class="flex gap-2">
                    <button onclick="copyLink()" class="p-2 text-stone-500 hover:bg-stone-200 rounded-full">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z">
                            </path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Comments Section -->
            <div class="mt-16 pt-10 border-t border-stone-200 font-sans">
                <h3 class="text-2xl font-bold mb-8 text-stone-800">Responses ({{ post.comments.count }})</h3>

                <!-- Comment Form -->
                {% if user.is_authenticated %}
                <div class="flex gap-4 mb-10">
                    <div class="flex-shrink-0">
                        {% if user.blogprofile.profile_picture %}
                        <img src="{{ user.blogprofile.profile_picture.url }}" class="w-10 h-10 rounded-full">
                        {% else %}
                        <img src="{% static "profile_image.png" %}" class="w-10 h-10 rounded-full">
                        {% endif %}
                    </div>
                    <form id="commentForm" class="flex-grow" onsubmit="submitComment(event)">
                        <textarea id="commentContent" name="content" rows="3"
                            class="w-full p-4 rounded-xl border border-stone-200 focus:border-stone-400 focus:ring-1 focus:ring-stone-400 transition-all resize-none text-stone-700 placeholder-stone-400 bg-stone-50"
                            placeholder="What are your thoughts?" required></textarea>
                        <div class="flex justify-end mt-2">
                            <button type="submit"
                                class="px-5 py-2 rounded-full bg-stone-700 text-white font-medium hover:bg-stone-800 transition">Respond</button>
                        </div>
                    </form>
                </div>
                {% else %}
                <div class="bg-stone-100 p-8 rounded-2xl text-center mb-10">
                    <p class="text-stone-600">Want to join the discussion?</p>
                    <a href="{% url 'a:login' %}"
                        class="inline-block mt-4 px-6 py-2 bg-stone-700 text-white rounded-full font-medium hover:bg-stone-800">Log In</a>
                </div>
                {% endif %}

                <!-- Comments List -->
                <div id="commentsList" class="space-y-8">
                    {% for comment in post.comments.all %}
                    {% if comment.is_approved %}
                    <div class="flex gap-4 comment-item" data-comment-id="{{ comment.id }}">
                        <div class="flex-shrink-0">
                            {% if comment.user.blogprofile.profile_picture %}
                            <img src="{{ comment.user.blogprofile.profile_picture.url }}"
                                class="w-10 h-10 rounded-full object-cover">
                            {% else %}
                            <div
                                class="w-10 h-10 rounded-full bg-stone-300 flex items-center justify-center text-stone-500">
                                {{ comment.user.username|slice:":1"|upper }}</div>
                            {% endif %}
                        </div>
                        <div class="flex-grow">
                            <div class="flex items-center justify-between mb-1">
                                <div class="flex items-center gap-2">
                                    <span class="font-bold text-stone-800">{{ comment.user.get_full_name|default:comment.user.username }}</span>
                                    <span class="text-xs text-stone-500">{{ comment.created_at|timesince }} ago</span>
                                </div>
                                {% if user == comment.user or user == post.author.user %}
                                <button onclick="deleteComment({{ comment.id }})" class="text-red-500 hover:text-red-700 text-sm">
                                    Delete
                                </button>
                                {% endif %}
                            </div>
                            <p class="text-stone-600 leading-relaxed">{{ comment.content }}</p>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
        </main>

        <!-- Right Sidebar (Desktop) -->
        <aside class="hidden lg:block w-80 font-sans">
            <div class="sticky top-24">
                <!-- Author Card -->
                <div class="bg-stone-100 p-6 rounded-2xl mb-6">
                    <div class="flex items-center gap-3 mb-3">
                        {% if post.author.profile_picture %}
                        <img src="{{ post.author.profile_picture.url }}" class="w-12 h-12 rounded-full object-cover">
                        {% endif %}
                        <div>
                            <h4 class="font-bold text-stone-800">{{ post.author.user.get_full_name }}</h4>
                            <p class="text-xs text-stone-500">Author</p>
                        </div>
                    </div>
                    <p class="text-sm text-stone-600 mb-4">{{ post.author.bio|truncatewords:20 }}</p>
                    <button
                        class="w-full py-2 bg-stone-700 text-white rounded-full text-sm font-medium hover:bg-stone-800 transition">Follow</button>
                </div>

                <!-- Recommended -->
                <h4 class="font-bold text-stone-800 mb-4 px-1">More from URL.ly</h4>
                <div class="space-y-4">
                    {% for rel in related_posts %}
                    <a href="{% url 'blog:blog_post_detail' rel.slug %}" class="block group">
                        <div class="flex gap-4 items-start">
                            {% if rel.cover_image %}
                            <div class="w-16 h-16 flex-shrink-0 rounded-lg overflow-hidden bg-stone-200">
                                <img src="{{ rel.cover_image.url }}"
                                    class="w-full h-full object-cover group-hover:scale-110 transition-transform">
                            </div>
                            {% endif %}
                            <div>
                                <h5
                                    class="font-bold text-sm text-stone-800 leading-snug group-hover:text-stone-600 transition-colors">
                                    {{ rel.title }}</h5>
                                <p class="text-xs text-stone-500 mt-1">{{ rel.published_at|date:"M d" }}</p>
                            </div>
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </div>
        </aside>

    </div>
</article>

<script>
    // Reading Progress
    window.onscroll = function () {
        let winScroll = document.body.scrollTop || document.documentElement.scrollTop;
        let height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
        let scrolled = (winScroll / height) * 100;
        document.getElementById("readingProgress").style.width = scrolled + "%";
    };

    // Keep existing ToggleLike logic
    function toggleLike(postId) {
        fetch(`/blog/posts/${postId}/like/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update counters without reload
                    const count = data.count;
                    const mC = document.getElementById('likeCount-mobile');
                    const dC = document.getElementById('likeCount-desk');
                    if (mC) mC.innerText = count;
                    if (dC) dC.innerText = count;

                    // Update visual state
                    const deskIcon = document.getElementById('likeIcon-desk');
                    const mobileIcon = document.getElementById('likeIcon-mobile');
                    const mobileBtn = document.getElementById('likeBtn-mobile');

                    if (data.liked) {
                        if (deskIcon) {
                            deskIcon.classList.remove('bg-stone-100', 'text-stone-400');
                            deskIcon.classList.add('bg-red-50', 'text-red-500');
                        }
                        if (mobileIcon) mobileIcon.innerText = '❤';
                        if (mobileBtn) {
                            mobileBtn.classList.remove('bg-red-50');
                            mobileBtn.classList.add('bg-red-100');
                        }
                    } else {
                        if (deskIcon) {
                            deskIcon.classList.remove('bg-red-50', 'text-red-500');
                            deskIcon.classList.add('bg-stone-100', 'text-stone-400');
                        }
                        if (mobileIcon) mobileIcon.innerText = '♥';
                        if (mobileBtn) {
                            mobileBtn.classList.remove('bg-red-100');
                            mobileBtn.classList.add('bg-red-50');
                        }
                    }
                }
            });
    }

    function copyLink() {
        navigator.clipboard.writeText(window.location.href).then(() => {
            alert('Link copied to clipboard!');
        });
    }

    // Comment Functions
    function submitComment(event) {
        event.preventDefault();
        const content = document.getElementById('commentContent').value.trim();
        if (!content) return;

        fetch(`/blog/posts/{{ post.id }}/comment/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: `content=${encodeURIComponent(content)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Add new comment to list
                const commentsList = document.getElementById('commentsList');
                const newComment = document.createElement('div');
                newComment.className = 'flex gap-4 comment-item';
                newComment.dataset.commentId = data.comment.id;
                newComment.innerHTML = `
                    <div class="flex-shrink-0">
                        ${data.comment.profile_picture 
                            ? `<img src="${data.comment.profile_picture}" class="w-10 h-10 rounded-full object-cover">`
                            : `<div class="w-10 h-10 rounded-full bg-stone-300 flex items-center justify-center text-stone-500">${data.comment.user.charAt(0).toUpperCase()}</div>`
                        }
                    </div>
                    <div class="flex-grow">
                        <div class="flex items-center justify-between mb-1">
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-stone-800">${data.comment.user}</span>
                                <span class="text-xs text-stone-500">Just now</span>
                            </div>
                            <button onclick="deleteComment(${data.comment.id})" class="text-red-500 hover:text-red-700 text-sm">
                                Delete
                            </button>
                        </div>
                        <p class="text-stone-600 leading-relaxed">${data.comment.content}</p>
                    </div>
                `;
                commentsList.insertBefore(newComment, commentsList.firstChild);

                // Clear form and update count
                document.getElementById('commentContent').value = '';
                document.querySelector('h3').textContent = `Responses (${data.count})`;
            } else {
                alert(data.error || 'Failed to add comment');
            }
        });
    }

    function deleteComment(commentId) {
        if (!confirm('Are you sure you want to delete this comment?')) return;

        fetch(`/blog/comments/${commentId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const comment = document.querySelector(`[data-comment-id="${commentId}"]`);
                if (comment) comment.remove();
                document.querySelector('h3').textContent = `Responses (${data.count})`;
            } else {
                alert(data.error || 'Failed to delete comment');
            }
        });
    }
</script>

{% endblock %}